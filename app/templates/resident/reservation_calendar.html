{% extends "base.html" %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0">{{ title }}</h2>
    <a href="{{ url_for('resident.list_reservation_areas') }}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left me-2"></i>Tüm Alanlara Geri Dön
    </a>
</div>

<div class="card shadow-sm">
    <div class="card-body">
        <div id="calendar"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        var calendarEl = document.getElementById('calendar');

        // --- GÜNCELLENEN YARDIMCI FONKSİYON ---
        function redirectToCreatePage(start, end) {
            // .toISOString() yerine, saat dilimini koruyan bir format oluşturuyoruz.
            // Bu format, Python'daki strptime tarafından tanınabilir.
            const offset = start.getTimezoneOffset();
            const startStr = new Date(start.getTime() - (offset*60*1000)).toISOString().slice(0, -1);
            const endStr = new Date(end.getTime() - (offset*60*1000)).toISOString().slice(0, -1);

            const encodedStart = encodeURIComponent(startStr);
            const encodedEnd = encodeURIComponent(endStr);
            const url = `/reservation/area/{{ area.id }}/new?start=${encodedStart}&end=${encodedEnd}`;
            window.location.href = url;
        }
        // --- ---

        const isMobile = window.innerWidth < 768;

        let calendarOptions = {
            locale: 'tr',
            allDaySlot: false,
            slotMinTime: '08:00:00',
            slotMaxTime: '23:00:00',
            events: `/api/reservations/{{ area.id }}`,
            selectable: true,
            
            select: function(info) {
                // Değişiklik: Fonksiyona artık metin değil, Date nesnelerini gönderiyoruz.
                redirectToCreatePage(info.start, info.end);
            },

            dateClick: function(info) {
                const start = info.date;
                const end = new Date(start.getTime() + (60 * 60 * 1000));
                // Değişiklik: Fonksiyona artık metin değil, Date nesnelerini gönderiyoruz.
                redirectToCreatePage(start, end);
            },
            
            initialView: isMobile ? 'timeGridDay' : 'timeGridWeek',
            headerToolbar: {
                left: isMobile ? 'prev,next' : 'prev,next today',
                center: 'title',
                right: isMobile ? 'timeGridDay,timeGridWeek' : 'dayGridMonth,timeGridWeek,timeGridDay'
            }
        };

        var calendar = new FullCalendar.Calendar(calendarEl, calendarOptions);
        calendar.render();

        window.addEventListener('resize', function() {
            if (window.innerWidth < 768) {
                calendar.changeView('timeGridDay');
            } else {
                calendar.changeView('timeGridWeek');
            }
        });
    });
</script>
{% endblock %}